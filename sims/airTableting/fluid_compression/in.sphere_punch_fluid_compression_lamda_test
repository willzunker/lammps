############################### SIMULATION SETTINGS ###################################################

units si
atom_style sphere
atom_modify first big
boundary f f f 
newton on
timestep 1e-4

############################################ ADD IN BIG PARTICLES #####################################

read_data sphere_punch.data 
variable radius_big equal 0.4e-3
variable density_big equal 1560

############################### ADD IN MPCD PARTICLES ###################################################

variable die_xh equal  4e-3
variable die_xl equal -4e-3
variable die_yh equal  4e-3
variable die_yl equal -4e-3
variable die_zh equal  1e-2
variable die_zl equal  0.0

variable num_mpcd equal 500000
variable diameter_mcpd equal 2*${radius_big}/20
variable velocity_mpcd equal ${radius_big}/(5*dt)
variable mass_mpcd equal 4/3*PI*${radius_big}^3*${density_big}*1e-2

region         insert_mpcd block ${die_xl} ${die_xh} ${die_yl} ${die_yh} ${die_zl} ${die_zh}
create_atoms   2 random ${num_mpcd} 13214 insert_mpcd

############################### REMOVE OVERLAPS BETWEEN BIG AND SMALL ####################################

variable skin_dis equal 2*${radius_big}*0.3
variable cutoff_dis equal 3.5*${radius_big}
variable overlap_delete equal 2*${radius_big}*0.6

group		   big type 1
group		   small type 2
set		       group small mass ${mass_mpcd} 
set            group small diameter ${diameter_mcpd}

neighbor       ${skin_dis} multi
comm_modify	    mode multi group big vel yes

pair_style	   granular 
pair_coeff	   1 1 hooke 1e3 1e2 tangential linear_nohistory 1.0 0.4 
pair_coeff	   2 2 hooke 1e3 1e2 tangential linear_nohistory 1.0 0.4  
pair_coeff	   1 2 hooke 1e3 1e2 tangential linear_nohistory 1.0 0.4  

neigh_modify   one 20000
neigh_modify   page 200000
delete_atoms   overlap ${overlap_delete} small big

############################### SET INTERACTIONS BETWEEN ATOMS ####################################

velocity	    small create ${velocity_mpcd} 87287 loop geom

neighbor	    ${skin_dis} multi
neigh_modify	delay 0 every 1 check yes 
neigh_modify	include big

pair_style	   granular 
pair_coeff	   1 1 hooke 1e3 1e2 tangential linear_nohistory 1.0 0.4 cutoff ${cutoff_dis}
pair_coeff	   2 2 hooke 1e3 1e2 tangential linear_nohistory 1.0 0.4 cutoff 0.0
pair_coeff	   1 2 hooke 1e3 1e2 tangential linear_nohistory 1.0 0.4 cutoff 0.0

############################### DEFINE MPCD PARTICLE PROPERTIES ###################################

variable        mpcd_wall_zl equal ${die_zl} 
variable        mpcd_wall_zh equal ${die_zh} 
variable 		mpcd_grid_size equal 2*${radius_big}/8
variable 		temp_mpcd equal 9.4e13
variable 		N_reset equal 50
fix	            2a small srd ${N_reset} big ${temp_mpcd} ${mpcd_grid_size} 3122 &
		        cubic warn 0.0001 shift yes 49829 &
		        overlap yes collision noslip tstat yes bounce 10 inside ignore
fix		        3 all wall/srd xlo ${die_xl} xhi ${die_xh} ylo ${die_yl} yhi ${die_yh} zlo ${die_zl} zhi ${die_zh}

######################################### RUN SIMULATION ##########################################


variable        compression_steps equal 500
variable        upper_punch_stroke equal 0.5*(${die_zh}-${die_zl})
variable 		disp0 equal 0.0
variable        disp_upper equal -elapsed/${compression_steps}*${upper_punch_stroke}
variable 		vel0 equal 0.0
variable 		velz equal -1/${compression_steps}*${upper_punch_stroke}/dt
fix				6 big move variable v_disp0 v_disp0 v_disp_upper v_vel0 v_vel0 v_velz 

thermo		    100
thermo_style	custom step atoms ke press
thermo_modify   lost ignore
dump            1 all custom 5 sphere_punch_fluid_compression_lambda_test.dump id type mass diameter x y z vx vy vz

compute Fz_com big reduce sum fz
variable Fz equal c_Fz_com
variable p equal v_Fz/((${die_xh}-${die_xl})*(${die_yh}-${die_xl}))
variable wall_hi equal ${die_zh}+v_disp_upper
fix log all print 1 "${wall_hi} ${p} ${num_mpcd} ${temp_mpcd}" file sphere_punch_eqn_of_state_lambda_test.csv screen no

##### Compression #####

run             ${compression_steps}

	

