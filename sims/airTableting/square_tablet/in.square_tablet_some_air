############################### SIMULATION SETTINGS ###################################################

units si
atom_style sphere
atom_modify first powder
boundary f f f 
newton on
timestep 1e-6

############################################ ADD IN BIG PARTICLES #####################################

read_data spheres.data
read_data sphere_punch.data add append

variable radius_sphere_punch equal 0.4e-3

############################### DEFINE MDR QUANTITIES ###################################################

variable radius_powder equal 0.5e-3
variable density_powder equal 1560
variable YoungsModulus equal 1e6
variable PoissonsRatio equal 0.3
variable YieldStress equal 2e4
variable SurfaceEnergy equal 100
variable SurfaceEnergyWall equal 0.0
variable psi_b equal 0.5
variable CoR equal 0.5
variable kt equal 2/7*${YoungsModulus}*${radius_powder}
variable xgammat equal 0.0
variable mu_s equal 0.7
variable mu_s_wall equal 0.1
variable mu_roll equal 0.55
variable k_roll equal 2.25*${mu_roll}*${mu_roll}*${YoungsModulus}*${radius_powder}
variable gamma_roll equal 0.0

variable atom_contact_string string "mdr ${YoungsModulus} ${PoissonsRatio} ${YieldStress} ${SurfaceEnergy} ${psi_b} ${CoR} damping none tangential linear_history ${kt} ${xgammat} ${mu_s} rolling sds ${k_roll} ${gamma_roll} ${mu_roll}" 
variable wall_contact_string string "granular mdr ${YoungsModulus} ${PoissonsRatio} ${YieldStress} ${SurfaceEnergyWall} ${psi_b} ${CoR} damping none tangential linear_history ${kt} ${xgammat} ${mu_s_wall} rolling sds ${k_roll} ${gamma_roll} ${mu_roll}"
variable zero_contact_string string "hooke 0.0 0.0 tangential linear_nohistory 0.0 0.0"

############################### ADD IN MPCD PARTICLES ###################################################

variable die_xh equal  4e-3
variable die_xl equal -4e-3
variable die_yh equal  4e-3
variable die_yl equal -4e-3
variable die_zh equal  1e-2
variable die_zl equal  0.0

variable num_mpcd equal 50000
variable diameter_mcpd equal 2*${radius_sphere_punch}/20
variable velocity_mpcd equal ${radius_powder}/(5*dt)
variable mass_mpcd equal 4/3*PI*${radius_sphere_punch}^3*${density_powder}*1e-3

region         insert_mpcd block ${die_xl} ${die_xh} ${die_yl} ${die_yh} ${die_zl} ${die_zh}
create_atoms   3 random ${num_mpcd} 13214 insert_mpcd

############################### REMOVE OVERLAPS BETWEEN BIG AND SMALL ####################################

variable skin_dis equal 2*${radius_powder}*0.3
variable cutoff_dis equal 3.5*${radius_powder}
variable overlap_delete_powder equal 2*${radius_powder}*0.6
variable overlap_delete_sphere_punch equal 2*${radius_sphere_punch}*0.6

atom_modify    first powder
group		   powder type 1
group		   small type 3
group 		   sphere_punch type 2
group 		   big type 1 2
set		       group small mass ${mass_mpcd} 
set            group small diameter ${diameter_mcpd}

neighbor       ${skin_dis} multi
comm_modify	   mode multi group powder vel yes

pair_style	   granular 
pair_coeff	   1 1 ${atom_contact_string} 
pair_coeff	   2 2 ${atom_contact_string} 
pair_coeff	   3 3 ${atom_contact_string}  
pair_coeff	   1 2 ${atom_contact_string} 
pair_coeff	   1 3 ${atom_contact_string} 
pair_coeff	   2 3 ${atom_contact_string}  

neigh_modify   one 20000
neigh_modify   page 200000
delete_atoms   overlap ${overlap_delete_powder} small powder
delete_atoms   overlap ${overlap_delete_sphere_punch} small sphere_punch

############################### SET INTERACTIONS BETWEEN ATOMS ####################################

velocity	    small create ${velocity_mpcd} 87287 loop geom

neighbor	    ${skin_dis} multi
neigh_modify	delay 0 every 1 check yes 
neigh_modify	include powder

pair_style	   granular 
pair_coeff	   1 1 ${atom_contact_string} cutoff ${cutoff_dis}
pair_coeff	   2 2 ${atom_contact_string} cutoff 0.0
pair_coeff	   3 3 ${atom_contact_string} cutoff 0.0 
pair_coeff	   1 2 ${atom_contact_string} cutoff 0.0
pair_coeff	   1 3 ${atom_contact_string} cutoff 0.0 
pair_coeff	   2 3 ${atom_contact_string} cutoff 0.0 

fix             1a powder nve/sphere

############################### DEFINE MPCD PARTICLE PROPERTIES ###################################

variable        mpcd_wall_zl equal ${die_zl} 
variable        mpcd_wall_zh equal ${die_zh} 
variable 		mpcd_grid_size equal 2*${radius_sphere_punch}/4
variable 		temp_mpcd equal 9.4e13
variable 		N_reset equal 20
fix	            2a small srd ${N_reset} big ${temp_mpcd} ${mpcd_grid_size} 3122 &
		        cubic warn 0.0001 shift yes 49829 &
		        overlap yes collision noslip tstat yes bounce 10 inside ignore
fix		        3 all wall/srd xlo ${die_xl} xhi ${die_xh} ylo ${die_yl} yhi ${die_yh} zlo v_mpcd_wall_zl zhi v_mpcd_wall_zh

############################### DEFINE REGIONS AND THEIR INTERACTIONS #############################

variable        disp_upper equal 0
variable 		disp_lower equal 0
region          die1 block INF ${die_xl} ${die_yl} ${die_yh} ${die_zl} ${die_zh} side out 
region          die2 block ${die_xh} INF ${die_yl} ${die_yh} ${die_zl} ${die_zh} side out
region          die3 block ${die_xl} ${die_xh} INF ${die_yl} ${die_zl} ${die_zh} side out
region          die4 block ${die_xl} ${die_xh} ${die_yh} INF ${die_zl} ${die_zh} side out
region          upper_punch block ${die_xl} ${die_xh} ${die_yl} ${die_yh} ${die_zh} INF side out move NULL NULL v_disp_upper
region          lower_punch block ${die_xl} ${die_xh} ${die_yl} ${die_yh} INF ${die_zl} side out move NULL NULL v_disp_lower
fix             4a1 powder wall/gran/region ${wall_contact_string} region die1
fix 			4a2 powder wall/gran/region ${wall_contact_string} region die2
fix 			4a3 powder wall/gran/region ${wall_contact_string} region die3
fix 			4a4 powder wall/gran/region ${wall_contact_string} region die4
fix             4b powder wall/gran/region ${wall_contact_string} region upper_punch contacts 
fix             4c powder wall/gran/region ${wall_contact_string} region lower_punch contacts
fix             5 powder gravity 9.81 vector 0 0 -1

######################################### RUN SIMULATION ##########################################

compute avgPunchForce all reduce sum f_4b[4]
variable avgPunchForce equal c_avgPunchForce

fix print1 all print 1 "${disp_upper} ${avgPunchForce}" file force_disp_some_air.csv screen no 

variable        compression_steps equal 50000
variable        upper_punch_stroke equal 0.64*(${die_zh}-${die_zl})
variable 		disp0 equal 0.0
variable 		vel0 equal 0.0
variable 		velz equal 0.0
fix				6 sphere_punch move variable v_disp0 v_disp0 v_disp_upper v_vel0 v_vel0 v_velz 


thermo		    100
thermo_style	custom step atoms ke press
thermo_modify   lost ignore
dump            1 all custom 1000 square_tablet_some_air.dump id type mass diameter x y z vx vy vz


##### SETTLING #####

run		        50000

##### Compression #####

variable 		velz equal -1/${compression_steps}*${upper_punch_stroke}/dt
variable        disp_upper equal -elapsed/${compression_steps}*${upper_punch_stroke}
run             ${compression_steps}

##### RELEASE #####

variable 		release_steps equal ${compression_steps}
variable 		velz equal 1/${release_steps}*${upper_punch_stroke}/dt
variable  		disp_upper equal -${upper_punch_stroke}+elapsed/${release_steps}*${upper_punch_stroke}
variable 		mpcd_wall_zh equal ${die_zh}+elapsed/${release_steps}*${die_zh}
run             ${release_steps}

##### EJECTION #####

variable 		ejection_steps equal ${compression_steps}
variable 		disp_lower equal elapsed/${ejection_steps}*${die_zh}
variable 		disp_upper equal elapsed/${ejection_steps}*${die_zh}*0.9
variable 		velz equal 1/${ejection_steps}*${die_zh}*0.9/dt
variable 		mpcd_wall_zh equal 2*${die_zh}
variable 		mpcd_wall_zl equal ${die_zl}+v_disp_lower
run             ${ejection_steps}

##### FREE FLOAT #####

variable 		free_float_steps equal 15000
variable 		disp_lower equal ${die_zh}
variable 		disp_upper equal ${die_zh}*0.9
variable 		velz equal 0.0
variable 		mpcd_wall_zh equal ${disp_upper}
variable 		mpcd_wall_zl equal ${disp_lower} 
run 			${free_float_steps}		

